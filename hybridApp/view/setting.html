<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>个人信息</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="../css/mui.min.css">
    <link rel="stylesheet" href="../css/style/setting.css"/>
    <link rel="stylesheet" type="text/css" href="../css/feedback.css"/>
</head>

<body class="mui-fullscreen">
<!--页面主结构开始-->
<div id="app" class="mui-views">
    <div class="mui-view">
        <div class="mui-navbar">
        </div>
        <div class="mui-pages">
        </div>
    </div>
</div>
<!--页面主结构结束-->
<!--单页面开始-->
<div id="setting" class="mui-page">
    <!--页面标题栏开始-->
    <div class="mui-navbar-inner mui-bar mui-bar-nav">
        <button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
            <span class="mui-icon mui-icon-left-nav"></span>
        </button>
        <h1 class="mui-center mui-title">个人信息</h1>
    </div>
    <!--页面标题栏结束-->
    <!--页面主内容区开始-->
    <div class="mui-page-content">
        <div class="mui-scroll-wrapper">
            <div class="mui-scroll">
                <ul class="mui-table-view mui-table-view-chevron">
                    <li class="mui-table-view-cell mui-media">
                        <a class="mui-navigate-right" id="head">
                            <img class="mui-media-object mui-pull-left head-img" id="head-img" src="">
                        	<div class="mui-media-body">Hello
								<p class='mui-ellipsis'>用户名:<span id="userName"></span></p>
							</div>
                        </a>
                    </li>
                </ul>
                <ul class="mui-table-view mui-table-view-chevron">
                    <li class="mui-table-view-cell">
                        <a href="#nickNameBox" class="mui-navigate-right">
                            昵称
                            <span class="mui-pull-right" id="nickName"></span>
                        </a>
                    </li>
                    <li class="mui-table-view-cell">
                        <a href="#telephoneBox" class="mui-navigate-right">
                            手机号
                            <span class="mui-pull-right" id="telephone"></span>
                        </a>
                    </li>
                    <li class="mui-table-view-cell">
                        <a href="#passwordBox" class="mui-navigate-right" id="password">密码</a>
                    </li>
                </ul>
                <ul class="mui-table-view mui-table-view-chevron">
                    <li class="mui-table-view-cell">
                        <a href="#about" class="mui-navigate-right">系统消息 <i class="mui-pull-right update">V3.1.0</i></a>
                    </li>
                </ul>
                <ul class="mui-table-view">
                    <li class="mui-table-view-cell" style="text-align: center;">
                        <a id="loginOut">退出登录</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!--页面主内容区结束-->
</div>
<!--单页面结束-->

<div id="nickNameBox" class="mui-page">
    <div class="mui-navbar-inner mui-bar mui-bar-nav">
        <button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
            <span class="mui-icon mui-icon-left-nav"></span>
        </button>
        <h1 class="mui-center mui-title">修改昵称</h1>
        <button class="mui-btn mui-btn-blue mui-btn-link mui-pull-right">保存</button>
    </div>
    <div class="mui-page-content">
        <form class="mui-input-group">
            <div class="mui-input-row">
                <label>昵称</label>
                <input type="text" class="mui-input-clear" placeholder="新昵称">
            </div>
        </form>
    </div>
</div>
<div id="telephoneBox" class="mui-page">
    <div class="mui-navbar-inner mui-bar mui-bar-nav">
        <button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
            <span class="mui-icon mui-icon-left-nav"></span>
        </button>
        <h1 class="mui-center mui-title">修改手机号</h1>
    </div>
    <div class="mui-page-content">
        <form class="mui-input-group formBox">
            <div class="mui-input-row">
                <label>原手机号</label>
                <button type="button" class="mui-btn mui-btn-primary mui-right">验证码</button>
                <input type="text" placeholder="普通输入框" readonly="readonly">
            </div>
            <div class="mui-input-row">
                <label>验证码</label>
                <input type="number" class="mui-input-clear" placeholder="请输入验证码" maxlength="4">
            </div>

            <div class="mui-input-row">
                <label>新手机号</label>
                <button type="button" class="mui-btn mui-btn-primary mui-right">验证码</button>
                <input type="number" class="mui-input-clear" maxlength="11" placeholder="新手机号码">
            </div>
            <div class="mui-input-row">
                <label>验证码</label>
                <input type="number" class="mui-input-clear" placeholder="请输入验证码" maxlength="4">
            </div>
            <button type="button" class="mui-btn mui-btn-success mui-btn-block">提交修改</button>
        </form>
    </div>
</div>
<div id="passwordBox" class="mui-page">
    <div class="mui-navbar-inner mui-bar mui-bar-nav">
        <button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
            <span class="mui-icon mui-icon-left-nav"></span>
        </button>
        <h1 class="mui-center mui-title">修改密码</h1>
    </div>
    <div class="mui-page-content">
        <form class="mui-input-group" style="padding: 15px 0 50px;">
            <div class="mui-input-row">
                <label class="mui-text-right">旧密码</label>
                <input type="password" class="mmui-input-clear" placeholder="输入旧密码">
            </div>
            <div class="mui-input-row">
                <label class="mui-text-right">新密码</label>
                <input type="password" class="mui-input-clear" placeholder="输入新密码">
            </div>

            <div class="mui-input-row">
                <label class="mui-text-right">确认</label>
                <input type="password" class="mmui-input-clear" placeholder="确认新密码">
            </div>
            <button type="button" class="mui-btn mui-btn-success mui-btn-block">提交修改</button>
        </form>
    </div>
</div>

</body>
<script src="../js/mui.min.js"></script>
<script src="../js/mui.view.js"></script>
<script src='../js/feedback.js'></script>
<script src='../js/jquery-1.9.0.js'></script>
<script src='../js/controller/index.js'></script>
<script>
    mui.init();
    //初始化单页view
    var viewApi = mui('#app').view({
        defaultPage: '#setting'
    });
    //初始化单页的区域滚动
    mui('.mui-scroll-wrapper').scroll();

    setTimeout(function () {
    	console.log(user);
        document.getElementById("head-img").src = user.avatar;
        document.getElementById("userName").innerHTML = user.username;
        if(user.nickName){document.getElementById("nickName").innerHTML = user.nickName;}
        document.getElementById("telephone").innerHTML = user.telephone; 
    }, 0);


    var view = viewApi.view;
    (function ($) {
        //处理view的后退与webview后退
        var oldBack = $.back;
        $.back = function () {
            if (viewApi.canBack()) { //如果view可以后退，则执行view的后退
                viewApi.back();
            } else { //执行webview后退
                oldBack();
            }
        };
    })(mui);
    document.getElementById('loginOut').addEventListener('tap', function() {
		mui.get(smartCold+'/i/user/logout',function(data){
			localStorage.clear();
			mui.openWindow({
			    url: '../login.html',
			    id: '../login.html',
			    createNew:false,//是否重复创建同样id的webview，默认为false:不重复创建，直接显示
			    waiting:{
			      autoShow:true,//自动显示等待框，默认为true
			      title:'正在加载...',//等待对话框上显示的提示内容
			    }
			});
			//mui.back();
		},'json');
	})
    //更换头像
    mui(".mui-table-view-cell").on("tap", "#head", function (e) {
        if (mui.os.plus) {
            var a = [{
                title: "拍照"
            }, {
                title: "从手机相册选择"
            }];
            plus.nativeUI.actionSheet({
                title: "修改头像",
                cancel: "取消",
                buttons: a
            }, function (b) {
                switch (b.index) {
                    case 0:
                        break;
                    case 1:
                        getImage();
                        break;
                    case 2:
                        galleryImg();
                        break;
                    default:
                        break
                }
            })
        }

    });

    function getImage() {
        var c = plus.camera.getCamera();
        c.captureImage(function (e) {
            plus.io.resolveLocalFileSystemURL(e, function (entry) {
                var s = entry.toLocalURL() + "?version=" + new Date().getTime();
                console.log(s);
                document.getElementById("head-img").src = s;
                //变更大图预览的src
                //目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
                document.querySelector("#__mui-imageview__group .mui-slider-item img").src = s + "?version=" + new Date().getTime();
            }, function (e) {
                console.log("读取拍照文件错误：" + e.message);
            });
        }, function (s) {
            console.log("error" + s);
        }, {
            filename: "_doc/head.jpg"
        })
    }

    function galleryImg() {
        plus.gallery.pick(function (a) {
            plus.io.resolveLocalFileSystemURL(a, function (entry) {
                plus.io.resolveLocalFileSystemURL("_doc/", function (root) {
                    root.getFile("head.jpg", {}, function (file) {
                        //文件已存在
                        file.remove(function () {
                            console.log("file remove success");
                            entry.copyTo(root, 'head.jpg', function (e) {
                                    var e = e.fullPath + "?version=" + new Date().getTime();
                                    document.getElementById("head-img").src = e;
                                    //document.getElementById("head-img1").src = e;
                                    //变更大图预览的src
                                    //目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
                                    document.querySelector("#__mui-imageview__group .mui-slider-item img").src = e + "?version=" + new Date().getTime();
                                    ;
                                },
                                function (e) {
                                    console.log('copy image fail:' + e.message);
                                });
                        }, function () {
                            console.log("delete image fail:" + e.message);
                        });
                    }, function () {
                        //文件不存在
                        entry.copyTo(root, 'head.jpg', function (e) {
                                var path = e.fullPath + "?version=" + new Date().getTime();
                                document.getElementById("head-img").src = path;
                                //document.getElementById("head-img1").src = path;
                                //变更大图预览的src
                                //目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
                                document.querySelector("#__mui-imageview__group .mui-slider-item img").src = path;
                            },
                            function (e) {
                                console.log('copy image fail:' + e.message);
                            });
                    });
                }, function (e) {
                    console.log("get _www folder fail");
                })
            }, function (e) {
                console.log("读取拍照文件错误：" + e.message);
            });
        }, function (a) {
        }, {
            filter: "image"
        })
    };

</script>

</html>