<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions" lang="en">
	<head>
		<title>设备数据</title>
		<meta name="keywords" content="enter,your,keywords,here"/>
		<meta name="description" content="A short description of this page."/>
		<meta name="content-type" content="text/html; charset=UTF-8"/>
		<link rel="stylesheet" type="text/css" href="assets/css/reset.css"/>
		 <link rel="stylesheet" href="assets/css/bootstrap.min.css"/>
		 <link rel="stylesheet" type="text/css" href="assets/css/index.css"/>
	    <link rel="stylesheet" type="text/css" media="all" href="assets/jedate/skin/jedate.css" />
	    <script type="text/javascript" src="assets/plugins/jQuery/jQuery-2.1.4.min.js"></script>
	    <script type="text/javascript" src="bower_components/angular/angular.min.js"></script>
	    	<script src="bower_components/angular-bootstrap/ui-bootstrap-tpls.min.js?"></script>
	    <script type="text/javascript" src="assets/jedate/jquery.jedate.js"></script>
	       <style>
         #deiv_ml *{margin-left: 10px;    display: inline;}
         #deiv_ml select,#deiv_ml input{height: 30px;border-radius: 5px;}.alert {margin-bottom: 0px;}
    </style>
    </head>
	<body>
		 <div id="div_main" ng-app="app"  ng-controller="zsdata" style="display: none;" >
			   <div id="dev_login" ng-if="sid==null" >
			            <!-- 登录START -->
					    <div class="head"><div class="logoArea pull-left"><h1 class="logo  pull-left"></h1><h3 class="manage  pull-left">设备管理系统</h3></div></div>
			    		<div class="content" style="background: #303A44">            
			                <div class="panel panel-success">
			                   <div class="panel-heading">
			                      <h3 class="panel-title">设备管理员登陆</h3>
			                   </div>
			                   <div class="panel-body">
			                      <div class="main-form-container">
			                        <div class="form-group">
			                            <input type="text" class="form-control" name="adminname" id="adminname" placeholder='用户名' >
			                            <!-- 错误信息 popover -->
			                            <div class="err-popover-out">
			                                <div class="err-popover">
			                                    <div class="tri-right"></div>
			                                    <div class="tri-right-in"></div>
			                                    <div class="err-popover-content"></div>
			                                </div>
			                            </div>
			                            <!-- 错误信息 popover end -->
			                        </div>
			                        <div class="form-group">
			                            <input type="password" class="form-control" id="adminpwd" name="adminpwd" placeholder='密码' >
			                            <!-- 错误信息 popover -->
			                            <div class="err-popover-out">
			                                <div class="err-popover">
			                                    <div class="tri-right"></div>
			                                    <div class="tri-right-in"></div>
			                                    <div class="err-popover-content"></div>
			                                </div>
			                            </div>
			                            <!-- 错误信息 popover end -->
			                        </div>
			                        <button type="button" id="submit" class="btn btn-form-common form-control" ng-click="login();"><span>登录</span></button>
			                        <div class="row">
			                          <div class="col-xs-8">
			                            <a style="color:red" hidden=true id="mention">用户名或密码错误</a>
			                          </div>
			                        </div>
			                   </div>
			                </div>
			    		 </div>
				      </div>
				      <!-- 登录END -->
			   </div>

		       <div id="dev_center" ng-show="sid!=null" >
		       		<div class="text-center"><h2>设备数据查询<span class="btn btn-warning pull-right" ng-click="loginout()">{{sid.username}}退出</span></h2></div>
<!-- 				    <div class="text-center"><h2>设备数据查询</h2><span ng-click="loginout()">{{sid.username}}退出</span> </div> -->
				    <div id="deiv_ml"  class="alert alert-info" >
				      <div >
					      <label>数据类型：</label>
					      <select id="sl_datatype" ng-model="datatype" ng-options="obj.val as obj.text for obj in datatypeMode" ></select>
				      </div>
				      <div  ng-show="datatype==1">
					      <label >APID:</label>
					      <input  ng-model="apid" >
				      </div>
				      <div ng-show="datatype!=1">
					      <label >DEVID:</label>
					      <input  ng-model="devid" >
				      </div>
				      <div>
					      <label>设备值:</label>
					       <select id="sl_timetype" ng-model="devkey" ng-options="obj.val as obj.text for obj in keyMode[datatype]">
					       <option value="" selected="selected">===全部===</option>
					        </select>
				      </div>
				      <div >
					      <label >时间范围:</label>
					       <select id="sl_timetype" ng-model="timetype" ng-options="obj.val as obj.text for obj in timetypeMode"></select>
				      </div>
				      <div ng-show="timetype==5">
					      <label >开始时间:</label>
					      <input id="start_time" type="text" class="workinput wicon"  placeholder="请选择" readonly ng-model="starttime">
				      </div>
				      <div ng-show="timetype==5">
					      <label >结束时间:</label>
					      <input id="end_time" type="text" placeholder="请选择"  readonly ng-model="endtime">
				      </div>
				     <div ng-show="timetype==1"  class="checkbox">
				         <label> <input type="checkbox" ng-model="retdata" ng-checked="retdata" ng-change="clintref()" style="margin: 0px 0px 0px -20px;" >自动查询（30秒查询一次） </label>
				      </div>
				      <button type="button" class="btn btn-info" ng-click="loadData()">查询</button>
				    </div>
				    <div id="div_table1">
				      	<table id="loding" class="table table-bordered">
								<caption  ng-show="timetype==1&&retdata&&reftime" >
								  <div>
								    <span id="sp_cutttime" ></span>
								    <span > <span>离下次刷新时间还有：</span><em id="em_diftime" style="color: red">30</em>秒</span>
								  </div>
								</caption>
								<thead>
									<tr>
						               	<th ng-repeat="x in tablemode[datatype].title">{{x}}</th>
									</tr>
								</thead>
								<tbody>
									<tr ng-repeat="obj in dataList">
									    <td>{{obj.id}}</td>
									    <td>{{obj.apid}}</td>
									    <td ng-if="datatype!=1"> {{obj.devid}}</td>
									    <td>{{obj.key}}</td>
									    <td>{{obj.value}}</td>
									    <td>{{obj.time}}</td>
									    <td>{{obj.addtime}}</td>
									</tr>
								</tbody>
							</table>
				    
                        </div>
				           <!-- 翻页功能 -->
		                  <div class="row" style="text-align:center">
		                    <pagination ng-change="loadData()" total-items="bigTotalItems"  ng-model="bigCurrentPage" max-size="pageSize" class="pagination-sm"   boundary-links="true" rotate="false" num-pages="numPages"></pagination>
		                 </div>
			  </div>
        </div>
	</body>
	<script type="text/javascript">
	 var sp_cutttime=$("#sp_cutttime"),em_diftime=$("#em_diftime"), cuindex=30;
	  Date.prototype.Format = function (fmt) { //author: meizz 
		    var o = {
		        "M+": this.getMonth() + 1, //月份 
		        "d+": this.getDate(), //日 
		        "HH+": this.getHours(), //小时 
		        "m+": this.getMinutes(), //分 
		        "s+": this.getSeconds(), //秒 
		        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
		        "S": this.getMilliseconds() //毫秒 
		    };
		    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
		    for (var k in o)
		    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
		    return fmt;
		};
	  var app = angular.module('app', []);
	   app.controller('zsdata', function($http, $location,$scope) {
		 $http({method:'GET',url:'/i/admin/findAdmin'}).success(function(data){admin = data.entity;  if(admin == null || admin.id == 0){ $scope.sid=undefined;}else{ $scope.usertype=admin.role;$scope.sid=admin;window.sessionStorage.devuser=admin;}$("#div_main").show();  }) ;
	    $scope.usertype=null; $scope.apid='';$scope.devid='';
	    $scope.datatypeMode=[{val:"1",text:"AP设备状态"},{val:"2",text:"DEV设备状态"},{val:"3",text:"DEV数据状态"}];
	    $scope.timetypevl=[1,1,3,6,12,24];
	    $scope.timetypeMode=[{val:1,text:"近一小时"},{val:2,text:"近3小时"},{val:3,text:"近6小时"},{val:4,text:"近一天"}];
	    $scope.keyMode= [[],
	                     [{val:"'MSI'",text:"MSI"},{val:"'LAC'",text:"LAC"},{val:"'CID'",text:"CID"}],
	                     [{val:"'BSI'",text:"BSI"},{val:"'DU'",text:"DU"}],
	                     [{val:"'Temp'",text:"温度"},{"'Switch'":2,text:"门"},{val:"'AU','BU','CU'",text:"电压"},{val:"'AI','BI','CI'",text:"电流"},{val:"'PWC'",text:"电量"}]
	    ];
	    $scope.datatype=$scope.datatypeMode[0].val;  
	    $scope.timetype= $scope.timetypeMode[0].val;// devkey 
	    $scope.devkey= $scope.keyMode[1].val;
	    $scope.dataList=undefined;
	    $scope.pageSize = 100; $scope.bigTotalItems = 0;$scope.bigCurrentPage = 1; 
	   
	    sp_cutttime.html(new Date().Format("yyyy-MM-dd HH:mm:ss"));
	    $scope.tablemode=[{},
	                      {title:["ID","APID","采集名称","采集值","采集时间","上传时间"],node:['id','apid','key','value','time','addtime'] },
	                      {title:["ID","APID","DEVID","采集名称","采集值","采集时间","上传时间"],node:['id','apid','deviceid','key','value','time','addtime'] },
	                      {title:["ID","APID","DEVID","采集名称","采集值","采集时间","上传时间"],node:['id','apid','deviceid','key','value','time','addtime'] }
	                      ];
	    if($scope.usertype==-2||$scope.usertype>=0){$scope.timetypeMode.push({val:5,text:"自定义"});}
	    
	    function getFormatTimeString(delta){
			return delta.toISOString().replace("T", " ").replace(/\..*/,"");
		}
	    
	    
	    function getNowFormatDate(date) {
	        var seperator1 = "-",seperator2 = ":", month = date.getMonth() + 1, strDate = date.getDate();
	        if (month >= 1 && month <= 9) {  month = "0" + month;  }
	        if (strDate >= 0 && strDate <= 9) { strDate = "0" + strDate;  }
	        return date.getFullYear() + seperator1 + month + seperator1 + strDate
	                + " " + date.getHours() + seperator2 + date.getMinutes()
	                + seperator2 + date.getSeconds();
	    }
	    
	    function showErrorInfo(msg){var msgEl = $("#mention");if(msg == null || msg == ''){  msgEl.hide();msgEl.html('');}else{msgEl.show();msgEl.html(msg);};}
		$scope.loginout=function() { $http.get('/i/admin/logout').success(function(data){$scope.sid=undefined;window.sessionStorage.clear();}); };
		$scope.login=function() {
			          window.sessionStorage.clear();
			          var me = "#submit";
				      if($(me).data('isLoading') === true)return;
					  showErrorInfo("");
					   if ($("#adminname").val() == '') {
							showErrorInfo("用户名不能为空！");
							return;
						} else if ($("#adminpwd").val() == '') {
							showErrorInfo("密码不能为空！");return;
						} 
						$(me).text("登录中...");
						$(me).data('isLoading',true);
						  $http({method:'POST',url:'/i/admin/userlogin',params:{adminName : $("#adminname").val(),adminPwd : $("#adminpwd").val(),sik:new Date().getHours()} }).success(function(data){ 
								$(me).text("登录");$(me).delay(500).data('isLoading',false);
								if (data.success) {
									 $scope.sid=data.entity.user;
									 $scope.usertype=data.entity.user.role;
									 window.sessionStorage.devuser=data.entity.user;
								} else {
									$scope.sid=undefined;
									window.sessionStorage.clear();
									showErrorInfo(data.message);
								}
							})  ;
			};
			
			$scope.loadData=function(){
				var stime=null,etime=null;
				if($scope.datatype==1){//AP状态数据
					if($scope.apid==null||$scope.apid==""){alert("请输入apid!")   ;  $scope.resttime();  return;}
				}else if($scope.datatype==2){//DEV数据
					if($scope.devid==null||$scope.devid==""){alert("请输入devid!"); $scope.resttime();return;}
				}else if($scope.datatype==3){//DEV采集数据
					if($scope.devid==null||$scope.devid==""){alert("请输入devid!"); $scope.resttime();return;}
				}
				if($scope.timetype<5){
					etime= new Date(),etimes= etime.getTime(),stime=new Date(etimes-3600000*$scope.timetypevl[$scope.timetype]);
					etime=	getNowFormatDate(etime),stime=	getNowFormatDate(stime);
				}else{
					etime=$scope.endtime;
					stime=$scope.starttime;
				}
				if($scope.retdata){//
					if($scope.reftime){
						 cuindex=30; 
					}else{
						 $scope.refdata();
					}
		         }else{
		        	 $scope.resttime();
			     }
				
				if(etime==null||stime==null){alert("请设置时间");return;}
				$http({
					method:'POST',
					url:'/i/Datar/findDataByFilter',
					params:{
						 pageNum   :     $scope.bigCurrentPage         ,
						 pageSize  :     $scope.pageSize        ,
						 dataType  :     $scope.datatype        ,
						 apid      :     $scope.apid       ,
						 devid     :     $scope.devid         ,
						 key       :     $scope.devkey       ,
						 startTime     :     stime       ,
						 endTime     :     etime           
						} 
				   }).success(function(data){ 
				     if(data.success){
				    	 $scope.dataList=data.data;
				    	 $scope.bigTotalItems=data.total;
				     }else{
				    	 $scope.dataList=undefined;
				    	 $scope.bigTotalItems=0;
				     }
				});
				
			};
			
			$scope.clintref=function(){
				if(!$scope.retdata&&$scope.reftime){
					$scope.resttime();
				}
			};
			$scope.resttime=function(){
				$scope.retdata=false;
				if($scope.reftime){clearInterval( $scope.reftime);}
				cuindex=30;
			};
			$scope.refdata=function(){
						$scope.reftime=setInterval(function () {
							sp_cutttime.html(new Date().Format("yyyy-MM-dd HH:mm:ss"));
					 		 if(cuindex>0){ 
					 			cuindex--;
					 		 }else{
					 			 $scope.loadData(); cuindex=30; 
					 		  }
					 		em_diftime.html(cuindex);
					 	 }, 1000);
			};
			// var sp_cutttime=$("#sp_cutttime"),em_diftime=$("#em_diftime");
			var start = {
				    format: 'YYYY-MM-DD hh:mm:ss',
				    minDate: $.nowDate(-3),
				    initAddVal:[-1,"hh"],   //初始化日期加2小时
				    isinitVal:true,
				    festival:true,
				    ishmsVal:false,
				    maxDate:$.nowDate(0), //最大日期
				    choosefun: function(elem,datas){
				        end.minDate = datas; //开始日选好后，重置结束日的最小日期
				    }
				};
				var end = {
				    format: 'YYYY年MM月DD日 hh:mm:ss',
				    minDate: $.nowDate(0), //设定最小日期为当前日期
				    festival:true,
				    maxDate: $.nowDate(0), //最大日期
				    choosefun: function(elem,datas){
				        start.maxDate = datas; //将结束日的初始值设定为开始日的最大日期
				    }
				};
				$('#start_time').jeDate(start);
				$('#end_time').jeDate(end);
	  });
	</script>
</html>
