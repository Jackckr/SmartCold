<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>登录-冷库能效在线管理系统</title>
    <meta charset="utf-8" name="keywords" content="冷库360,冷库监控,冷库智能管理,冷库能效评估，冷库认证与能耗管理"/>
    <meta charset="utf-8" name="description" content="冷库360-冷库能效在线管理系统"/>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.5 -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/fonts/iconfont.css">
    <link rel="stylesheet" id="link" href="assets/yili/yili.css">
</head>
<body class="hold-transition login-page login_new">
<!-- new login -->
<div class="smartCold">
    <div class="loginDiv">
        <h2></h2>
    </div>
    <div class="loginBody login-box">
        <div class="loginArea">
            <div class="register-box-body">
                <h1>新用户注册</h1>
                <form action="../../index.html" method="post">
                    <div class="form-group has-feedback">
                        <input id="txt_username" type="text" class="form-control" placeholder="用户名(手机号、邮箱等)" onblur="checkUserName()">
                        <span class="glyphicon glyphicon-user form-control-feedback"></span>
                    </div>
                    <p class="userMsg" style="color:#3c96c9"></p>
                    <div class="form-group has-feedback">
                        <input id="txt_password" type="password" class="form-control" placeholder="密码" onblur="checkpwd()">
                        <span class="glyphicon glyphicon-lock form-control-feedback"></span>
                    </div>
                    <p class="psdMsg" style="color:#3c96c9"></p>
                    <div class="form-group has-feedback">
                        <input  id="txt_refpassword" type="password" class="form-control" placeholder="重输密码" onblur="checkopwd()">
                        <span class="glyphicon glyphicon-log-in form-control-feedback"></span>
                    </div>
                    <p class="rePsdMsg" style="color:#3c96c9"></p>
                    <div class="form-group has-feedback">
                        <input id="txt_telephone" type="text" class="form-control" maxlength="11" placeholder="手机号" onblur="checktelephone()">
                        <span class="glyphicon glyphicon-earphone form-control-feedback" ></span>
                    </div>
                    <p class="telMsg" style="color:#3c96c9"></p>
                    <div class="input-group form-group">
                        <input id="txt_vicode" type="text" class="form-control" placeholder="输入验证码" onkeyup="checkcode(this)">
                        <span id="sp_yzmbut" class="input-group-addon btn btn-primary" onclick="getviercode(this)">获取验证码</span>
                    </div>
                    <p class="codeMsg" style="color:#3c96c9"></p>
                    <!--<div class="input-group form-group">
                        <label style="font-weight: 400;">
                            <input id="agreement" type="checkbox" checked>
                            我已阅读并同意
                            <a id="regAgreement" target="_blank" href="announcement.html">《冷库360使用协议》</a>
                        </label>
                    </div>-->
                    <div>
                        <button id="submit" type="button" class="btn btn-primary btn-block btn-flat" disabled onclick="reguser()">注册</button>
                    </div>
                    <div class="text-right" style="margin-top: 10px;">
                        <a href="yili.html">已经注册</a>
                    </div>
                </form>

                <div class="social-auth-links text-center">
                </div>

                <a href="login.html" class="text-center"></a>
            </div>
        </div>
    </div>
    <!--<div id="loginCopyR" class="loginCopyR">
        <p>&copy;2016&nbsp;逸励实业&nbsp;&nbsp;&nbsp;&nbsp;</p>
    </div>-->
</div>
<script src="assets/plugins/jQuery/jQuery-2.1.4.min.js"></script>
<script type="text/javascript">
    var mainHeight = $(window).height();
    $(".loginBody").height(mainHeight - 160);
    window.onresize = function () {
        var mainHeight = $(window).height();
        $(".loginBody").height(mainHeight - 160);
    };
    jQuery.ajaxSetup({xhrFields:{withCredentials:true}});

    function getCookie(name)
    {
        var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");

        if(arr=document.cookie.match(reg))

            return unescape(arr[2]);
        else
            return null;
    }
    function delCookie(name)
    {
        var exp = new Date();
        exp.setTime(exp.getTime() - 1);
        var cval=getCookie(name);
        if(cval!=null)
            document.cookie= name + "="+cval+";expires="+exp.toGMTString();
    }
    delCookie("token");
    $.ajax({type: "GET",cache: false,dataType: 'json',url: '/i/user/logout'}).success(function(data){});//清除服务器和本地缓存
    var victdata={code:null,key:new Date().getDate()*2, userName:false,victpwd:false,victel:false,victyzm:false};

    function checkinfo(){
        var vis=victdata.userName&&victdata.victpwd&&victdata.victel&&victdata.victyzm;
        $("#submit").attr("disabled",!vis);
    }

    function vsphone(telephone) {// 验证手机号码
        var length = (telephone + '').length;
        var mobile = /^1[3|4|5|7|8][0-9]\d{4,8}$/;
        return telephone && length == 11&& mobile.test(telephone);
    };
    function isChineseChar(str){
        var reg = /[\u4E00-\u9FA5\uF900-\uFA2D]/;
        return reg.test(str);
    }
    function checkUserName(){
        var oname=$("#txt_username").val().trim();
        if(oname==''){
            $(".userMsg").html("用户名不能为空~");
            victdata.userName=false;
            return false
        }else if(isChineseChar(oname)){
            $(".userMsg").html("用户名不能包含中文~");
            victdata.userName=false;
            return false
        }else if(oname.length>24||oname.length<3){
            $(".userMsg").html("用户名长度3~24位~");
            victdata.userName=false;
            return false
        }else{
            $.post('/i/user/existenceUserName',{userName:oname}, function(data) {
                if (data) {
                    victdata.userName = false;
                    $(".userMsg").html("用户名已存在<a href='login.html'>去登录</a>");
                } else {
                    $(".userMsg").html("");
                    victdata.userName = true;
                }
                checkinfo();
            });
        };
    };

    function checkcode(em) {
        victdata.victyzm = em.value.trim().length == 4 && victdata.code == em.value.trim();
        if(victdata.victyzm){
            $(".codeMsg").html("");
        }else{
            $(".codeMsg").html("验证码有误~");
        }
        checkinfo();
    }
    function getviercode(){
        if(!victdata.victel||!vsphone($("#txt_telephone").val())){checktelephone(); return ;}
        $.ajax({
            type : "POST",
            url : "http://liankur.com/" + '/i/ShareRdcController/sharvistPhone.json',
            data : {
                key : 'signUpCode',
                telephone : $("#txt_telephone").val().trim()
            },
            success : function(data) {
                if (data.success) {
                    victdata.code = data.entity;
                }
                alert(data.message);
            }
        });
    };

    //验证手机号码
    function checktelephone(){
        var telephone = $("#txt_telephone").val().trim();
        var ct = vsphone(telephone);
        if(telephone.length==11){
            $.ajax({url:"/i/user/checkTelephone",data:{telephone:telephone},type:"post",success:function (data) {
                if(!data){
                    victdata.victel=false;
                    $(".telMsg").html("该手机号已被注册~");
                    $('#sp_yzmbut').attr('disabled',true);
                    return;
                }
            }});
        }
        if(ct){
            victdata.victel=true;
            $(".telMsg").html("");
            $('#sp_yzmbut').attr('disabled',!ct);
        }else{
            victdata.victel=false;
            $(".telMsg").html("手机号不正确~");
            $('#sp_yzmbut').attr('disabled',!ct);
        }
        checkinfo();
    };

    function checkpwd(){
        victdata.victpwd=false;
        var password = $("#txt_password").val().trim();
        if(password == ''){
            $(".psdMsg").html("密码不能为空");
        }else if(/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,16}$/.test(password)){
            $(".psdMsg").html("");
            victdata.victpwd=true;
        }else{
            $(".psdMsg").html("密码长度6-16位,必须是数字字母组合");
        }
        checkinfo();
    }

    function checkopwd(){
        var password=$("#txt_password").val().trim(), repsword=$("#txt_refpassword").val().trim();
        if(password != repsword){
            $(".rePsdMsg").html("两次密码输入不一致，请重新输入");
            victdata.victpwd=false;
        }else{
            $(".rePsdMsg").html("");
            victdata.victpwd=true;
        }
        checkinfo();
    }

    function reguser(){
        var inputArry = $("input[type='text']"),i=0,len = inputArry.length;
        for(i; i<len; i++){
            if(inputArry.eq(i).val().trim()==""){
                alert("请填写完整再注册~");
                return
            }
        }
       /* if($('#agreement').is(':checked')){
        }else{
            alert("请确认您已同意冷库360协议~");
            return
        }*/
        var me = "#submit";
        if ($(me).data("isLoading") === true) { return; }
        var userMsg = $('.userMsg').html().trim(),
            psdMsg = $('.psdMsg').html().trim(),
            rePsdMsg = $('.rePsdMsg').html().trim(),
            telMsg = $('.telMsg').html().trim(),
            codeMsg = $('.codeMsg').html().trim();
        if(userMsg != ""){
            alert(userMsg);
        }else if(psdMsg != "" || rePsdMsg != ""){
            alert("密码输入不符合要求，请检查~");
        }else if(telMsg != ""){
            alert(telMsg);
        }else if(codeMsg != ""){
            alert(codeMsg);
        }else{
            $(me).text("注册中...");
            $(me).data("isLoading", true);
            if(victdata.userName&&victdata.victpwd&&victdata.victyzm){
                $.ajax({
                    type:"POST",
                    url:"/i/user/signup",
                    data:{
                        username:$("#txt_username").val().trim(),
                        password: $("#txt_password").val().trim(),
                        telephone: $("#txt_telephone").val().trim(),
                        signUpCode:$("#txt_vicode").val().trim(),
                    },
                    complete: function(e) {
                        $(me).text("注册");
                        $(me).delay(500).data("isLoading", false);
                    }
                }).success(function(data){
                    if(data.success){
                        alert('恭喜你，注册成功~');
                        document.cookie = data.message;
                        window.sessionStorage.sikey = data.message;
                        window.location.href  = "/autIdentity.html";
                        window.event.returnValue=false;
                    }else{
                        alert(dta.message);
                    }
                });
            }
        }
    }

</script>
</body>
</html>
