<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.smartcold.zigbee.manage.dao.RdcMapper">
    <resultMap id="BaseResultMap" type="com.smartcold.zigbee.manage.entity.RdcEntity" >
        <id column="id" property="id" jdbcType="INTEGER" />
        <result column="name" property="name" jdbcType="VARCHAR" />
        <result column="address" property="address" jdbcType="VARCHAR" />
        <result column="addtime" property="addtime" jdbcType="TIMESTAMP" />
    </resultMap>
    <sql id="Base_Column_List" >
        `id`, `name`, `address`,`userid`, `addtime`
    </sql>
    <select id="findRdcList" parameterType="map" resultType="RdcEntity">
         SELECT * FROM `Rdc` where `latitude`!=0 and `longitude`!=0 order by `addTime` desc
    </select>

    <select id="findRDCByRDCId" parameterType="map" resultType="RdcEntity">
        SELECT * FROM `Rdc` WHERE `id` = #{rdcID}
    </select>
	
	<select id="checkName" parameterType="String" resultType="int">
		SELECT count(name) FROM `Rdc` WHERE `name` = #{name}
	</select>
	
	<select id="checkCellphone" parameterType="String" resultType="boolean">
		SELECT count(cellphone) FROM `Rdc` WHERE `cellphone` = #{cellphone}
	</select>
	
	<delete id="deleteByRdcID">
		delete from rdc where id = #{rdcID}
	</delete>
	
    <insert id="insertRdc" parameterType="RdcEntity"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `Rdc` (
        `name`,
        `address`,
        `addtime`,
        `type`,
        `capacity`,
        `sqm`,
        `struct`,
        `storagetype`,
        `coldtype`,
        `provinceid`,
        `cityid`,
        `contact`,
        `position`,
        `cellphone`,
        `phone`,
        `commit`,
        `powerConsume`,
        `userid`,
        `longitude`,
        `latitude`,
        `height`,
        `rentSqm`,
        `openLIne`,
        `infoIntegrity`,
        `isJoinStand`
        )
        VALUES
        (
        #{name},
        #{address},
        now(),
        #{type},
        #{capacity},
        #{sqm},
        #{struct},
        #{storagetype},
        #{coldtype},
        #{provinceid},
        #{cityid},
        #{contact},
        #{position},
        #{cellphone},
        #{phone},
        #{commit},
        #{powerConsume},
        #{userid},
        #{longitude},
        #{latitude},
        #{height},
        #{rentSqm},
        #{openLIne},
        #{infoIntegrity},
        #{isJoinStand}
        );
    </insert>
    <update id="updateRdc" parameterType="com.smartcold.zigbee.manage.entity.RdcEntity" >
        update Rdc
        <set >
            <if test="name != null" >
                `name` = #{name,jdbcType=VARCHAR},
            </if>
            <if test="address != null" >
                address = #{address,jdbcType=VARCHAR},
            </if>
            <if test="sqm != null" >
                sqm = #{sqm,jdbcType=FLOAT},
            </if>
            <if test="struct != null" >
                struct = #{struct,jdbcType=VARCHAR},
            </if>
            <if test="capacity != null" >
                capacity = #{capacity,jdbcType=FLOAT},
            </if>
            <if test="cellphone != null" >
                cellphone = #{cellphone,jdbcType=VARCHAR},
            </if>
            <if test="phone != null" >
                phone = #{phone,jdbcType=VARCHAR},
            </if>
            <if test="commit != null" >
                commit = #{commit,jdbcType=VARCHAR},
            </if>
            <if test="longitude != null" >
                longitude = #{longitude,jdbcType=DOUBLE},
            </if>
            <if test="latitude != null" >
                latitude = #{latitude,jdbcType=DOUBLE},
            </if>
			<if test="audit != null" >
				audit = #{audit,jdbcType=INTEGER},
			</if>
            <if test="height != null" >
                `height` = #{height,jdbcType=FLOAT},
            </if>
            <if test="infoIntegrity != null" >
                `infoIntegrity` = #{infoIntegrity,jdbcType=INTEGER},
            </if>
            <if test="openLIne != null" >
                `openLIne` = #{openLIne,jdbcType=INTEGER},
            </if>
            <if test="rentSqm != null" >
                `rentSqm` = #{rentSqm,jdbcType=FLOAT},
            </if>
            <if test="isJoinStand != null" >
                `isJoinStand` = #{isJoinStand,jdbcType=INTEGER},
            </if>
            <if test="provinceid != null" >
                `provinceid` = #{provinceid,jdbcType=INTEGER},
            </if>
            <if test="cityid != null" >
                `cityid` = #{cityid,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    
    
    
    
    <select id="findRDCEntityDtoByRdcId" parameterType="map" resultType="com.smartcold.zigbee.manage.dto.RdcEntityDTO" >
			 SELECT
			r.id,
			r.provinceid,
			r.cityid,
			r.name,
			r.address,
			r.addtime,
			t.rdcscore score,
			t.rdccommentcnt userCommentCount,
			t.rdcrecommendpercent userRecommendPercent,
			t.pageview,
			( SELECT location 	FROM 	filedata f WHERE f.belongid = r.id AND f.category = 'storagePic' ORDER BY id DESC LIMIT 1) AS logo
		FROM
			Rdc r
		LEFT JOIN rdcext t ON t.RDCID = r.id
		WHERE 1=1
	        <if test="rdcID !=0"> and r.id = ${rdcID} </if> <!--  关键字 -->
        ORDER BY r.addTime DESC
	</select>

    <select id="getNewRdcList" parameterType="map" resultType="com.smartcold.zigbee.manage.dto.RdcEntityDTO">
        SELECT
        r.id,
        r.name,
        r.address,
        r.sqm,
        r.audit,
        r.istemperaturestandard,
        r.infoIntegrity,
        st.type tempTypeStr,
        sm.type manageTypeStr,
        s.datatype,
        s.typecode,
        s.sqm rentSqm,
        s.unitPrice,
        s.stauts shareStauts,
        t.rdcscore,
        (SELECT location FROM filedata f WHERE f.belongid = r.id AND f.category IN ('honorPic','storagePic') ORDER BY id DESC LIMIT 1 ) as logo
        FROM
        rdc r
        LEFT JOIN shared_info s ON s.rdcID = r.id
        LEFT JOIN rdcext t on r.id=t.RDCID
        LEFT JOIN storagetempertype st on st.id=t.storagetempertype
        LEFT JOIN storagemanagetype sm on sm.id=t.managetype
        <where>
            <if test="sqm !=null and  sqm != ''"> and ${sqm} </if>
            <if test="keyword !=null and  keyword != ''"> and r.name like '%${keyword}%' </if>
            <if test="provinceid !=null and  provinceid != ''"> and r.provinceid = #{provinceid} </if>
            <if test="managetype !=null and  managetype != ''"> and t.manageType IN  (${managetype})</if>
            <if test="storagetempertype !=null and  storagetempertype != ''"> and t.storagetempertype in (${storagetempertype})</if>
            <if test="istemperaturestandard !=null and istemperaturestandard!=''">and r.istemperaturestandard in (${istemperaturestandard})</if>
            <if test="audit !=null and audit!=''"> and r.audit in (${audit})</if>
            <if test="dataType !=null and dataType!=''"> and s.dataType=#{dataType}</if>
            <if test="typeCode !=null and typeCode!=''"> and s.typeCode=#{typeCode}</if>
            <if test="goodSaveType !=null and goodSaveType!=''">and t.storagetype in (${goodSaveType})</if>
            <if test="hasCar !=null and  hasCar != ''"> and t.hastruck in(${hasCar}) </if>
        </where>
        ORDER BY
        r.id DESC
    </select>
    
	<select id="findRDCByUserId" parameterType="map" resultType="com.smartcold.zigbee.manage.dto.RdcEntityDTO" >
			 SELECT
			r.id,
			r.name,
			r.address,
			r.addtime,
			t.rdcscore score,
			t.rdccommentcnt userCommentCount,
			t.rdcrecommendpercent userRecommendPercent,
			t.pageview,
			( SELECT location 	FROM 	filedata f WHERE f.belongid = r.id AND f.category = 'storagePic' ORDER BY id DESC LIMIT 1) AS logo
		FROM
			Rdc r
		LEFT JOIN rdcext t ON t.RDCID = r.id
		WHERE 1=1
	        <if test="userID !=0"> and r.userid = ${userID} </if> <!--  关键字 -->
	        <if test="keyword != null">
		        AND r.name like "%"#{keyword}"%"
		    </if>
       ORDER BY r.addTime DESC
	</select>
	<select id="findRDCById" parameterType="Integer" resultType="map" >
		 select 
            r.id,r.audit,  r.`name`,r.address,r.capacity,r.sqm,r.cellphone ,t.storagestruct,sgt.type struct ,r.coldtype,mt.type managetype,dt.type storagetype,te.type storagetempertype ,t.storagetruck,t.rdcscore,date_format(r.addtime, '%Y-%m-%d') addtime
        from rdc r 
		  LEFT JOIN rdcext t ON t.RDCID=r.id 
		  LEFT JOIN storagemanagetype mt on  mt.id=t.managetype
		  LEFT JOIN storagetype dt on  dt.id=t.storagetype
		  LEFT JOIN storagetempertype te on  te.id=t.storagetempertype 
      left join storagestruct sgt on   t.storagestruct=sgt.id
		where r.id=#{rdcID} 
		ORDER BY r.addtime desc ;
	</select>
    
    
	<select id="getRDCList" parameterType="map" resultType="com.smartcold.zigbee.manage.dto.RdcEntityDTO" >
	  SELECT 
			r.id,
			r.name,
			r.address,
			t.rdcscore score,
			t.rdccommentcnt userCommentCount,
			t.rdcrecommendpercent userRecommendPercent,
			t.pageview,
			( SELECT location 	FROM 	filedata f WHERE f.belongid = r.id AND f.category = 'storagePic' ORDER BY id DESC LIMIT 1) AS logo
		FROM
			Rdc r
		LEFT JOIN rdcext t ON t.RDCID = r.id
		WHERE audit!=-1 
	        <if test="keyword !=null and  keyword != ''"> and  ( r.name like '%${keyword}%' or r.address like '%${keyword}%' )</if> <!--  关键字 -->
    		<if test="provinceid !=null and  provinceid != ''"> and r.provinceid = #{provinceid} </if> <!--区域 -->
    		<if test="sqm !=null and  sqm != ''"> and ${sqm} </if><!-- -->
    		<if test="managementType !=null and  managementType != ''">  and t.managetype in(${managementType}) </if><!--  经营类型-->
    		<if test="storageType !=null and  storageType != ''">  and t.storagetype in(${storageType}) </if><!-- 存放类型-->
    		<if test="storagetempertype !=null and  storagetempertype != ''">  and t.storagetempertype in(${storagetempertype}) </if><!-- 温度类型-->
    		<if test="hasCar !=null and  hasCar != ''"> and <if test="hasCar ==1">!</if> ISNULL(t.storagetruck) </if><!-- 有无车辆-->
       ORDER BY r.addTime DESC
	</select>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
        select
        <include refid="Base_Column_List" />
        from Rdc
        where id = #{id,jdbcType=INTEGER}
    </select>
</mapper>